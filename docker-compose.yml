version: '3.8'

services:
  # Ollama AI Service
  ollama:
    image: ollama/ollama:latest
    container_name: mailjaeger-ollama
    volumes:
      - ollama_data:/root/.ollama
    ports:
      - "127.0.0.1:11434:11434"  # Bind to localhost only for security
    restart: unless-stopped
    # Uncomment for GPU support
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # MailJaeger Application
  mailjaeger:
    build: .
    container_name: mailjaeger-app
    ports:
      # Bind to localhost by default for security
      # Change to "8000:8000" to expose externally (ensure API_KEY is set!)
      - "127.0.0.1:8000:8000"
    environment:
      # SECURITY: Set API_KEY for authentication
      # Generate with: python -c 'import secrets; print(secrets.token_urlsafe(32))'
      - API_KEY=${API_KEY:-}
      
      # Server Configuration
      - SERVER_HOST=0.0.0.0  # Inside container, bind to all interfaces
      - SERVER_PORT=8000
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:8000,http://127.0.0.1:8000}
      
      # IMAP Configuration
      - IMAP_HOST=${IMAP_HOST}
      - IMAP_PORT=${IMAP_PORT:-993}
      - IMAP_USERNAME=${IMAP_USERNAME}
      - IMAP_PASSWORD=${IMAP_PASSWORD}
      
      # AI Configuration
      - AI_ENDPOINT=http://ollama:11434
      - AI_MODEL=${AI_MODEL:-mistral:7b-instruct-q4_0}
      
      # Database
      - DATABASE_URL=sqlite:///./data/mailjaeger.db
      
      # Processing
      - SPAM_THRESHOLD=${SPAM_THRESHOLD:-0.7}
      - MAX_EMAILS_PER_RUN=${MAX_EMAILS_PER_RUN:-200}
      
      # Mail Action Safety
      - SAFE_MODE=${SAFE_MODE:-true}
      - MARK_AS_READ=${MARK_AS_READ:-false}
      - DELETE_SPAM=${DELETE_SPAM:-false}
      - QUARANTINE_FOLDER=${QUARANTINE_FOLDER:-Quarantine}
      
      # Scheduling
      - SCHEDULE_TIME=${SCHEDULE_TIME:-08:00}
      - SCHEDULE_TIMEZONE=${SCHEDULE_TIMEZONE:-Europe/Berlin}
      
      # Learning
      - LEARNING_ENABLED=${LEARNING_ENABLED:-true}
      - LEARNING_CONFIDENCE_THRESHOLD=${LEARNING_CONFIDENCE_THRESHOLD:-0.8}
      
      # Storage
      - STORE_EMAIL_BODY=${STORE_EMAIL_BODY:-false}
      - STORE_ATTACHMENTS=${STORE_ATTACHMENTS:-false}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-false}
    
    volumes:
      - mailjaeger_data:/app/data
      # Optional: Mount .env file for secrets (alternative to environment variables)
      # - ./.env:/app/.env:ro
    
    depends_on:
      - ollama
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Security: Run as non-root user
    # Note: Adjust UID/GID if needed for your host system
    # Use `id -u` and `id -g` on host to get your UID/GID
    user: "1000:1000"

volumes:
  ollama_data:
    driver: local
  mailjaeger_data:
    driver: local
